<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Elevator Simulator</title>
    <link rel="stylesheet" href="style.css"> 
</head>
<body>
    <h1>Elevator Simulator</h1>



    <div class="container">



        <h2>Received Events</h2>
        <button onclick="toggleAutoReload()" id="reloadButton">Stop Auto Reload</button>
        <div class="events-box">
            <ul id="events"></ul>
        </div>
    </div>

    <div class="monitor-box">
        <h2>Monitorizare Etaj</h2>
        <p>Etaj curent: <span id="currentFloor">necunoscut</span></p>
    </div>


    <script>
        const apiUrl = "http://localhost:49570/api/simulator";
        let autoReloadInterval;
        let isAutoReloadEnabled = true;
        events_new = null;
        event_old = null;


        async function loadEvents() {
            const res = await fetch(apiUrl);
            const events = await res.json();
            const list = document.getElementById('events');
            list.innerHTML = '';
           
            // Definim un obiect care mapează valorile numerice la numele stărilor
            const stateNames = {
                0: "GoingUp",
                1: "GoingDown",
                2: "GroundFloor",
                3: "Floor1",
                4: "Floor2",
                5: "Floor3",
                6: "Floor4",
                7: "Stopped",
                8: "Running",
                9: "Wait"
            };

            events.forEach(ev => {
                const li = document.createElement('li');
                const stateName = stateNames[ev.state]; // Obține numele stării
                events_new = ev;
                //  console.log(stateName)
                li.textContent = `${stateName}`;
                list.appendChild(li);
            });
            if (events.length > 0) {
                const lastEvent = events[events.length - 1];
                const lastState = stateNames[lastEvent.state];
                setElevatorPosition(lastEvent);

            }
        }

        function toggleAutoReload() {
            const button = document.getElementById('reloadButton');
            if (isAutoReloadEnabled) {
                clearInterval(autoReloadInterval);
                button.textContent = "Pornește reîncărcarea automată";
                isAutoReloadEnabled = false;
            } else {
                startAutoReload();
                button.textContent = "Oprește reîncărcarea automată";
                isAutoReloadEnabled = true;
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }


        targetPosition = null;
        let currentPosition = 0; // Poziția curentă a liftului (0 = Parter, 1 = Etaj 1, etc.)
        let floorText = "Parter";
       async function setElevatorPosition(event)
       {

           if (currentPosition < 3)
               await sleep(1000); // Așteaptă 1 secundă
           else
               await sleep(2500);
          //  console.log("new"+events_new);
           // console.log("old"+event_old);
            const floorSpan = document.getElementById('currentFloor');
           
           
                switch (event.state) {
                    case 2: // GroundFloor
                        currentPosition = 0;
                        targetPosition = 0;
                       floorText = "Parter";
                        break;
                    case 3: // Floor1
                        targetPosition=1
                        currentPosition = 0;
                       // floorText = "Spre etaj 1";
                        break;
                    case 4: // Floor2
                        targetPosition = 2;
                        currentPosition = 0;
                   //    floorText = "spre etaj 2";
                        break;
                    case 5: // Floor3
                        targetPosition = 3;
                        currentPosition = 0;
                       // floorText = "Etaj 3";
                        break;
                    case 6: // Floor4
                        currentPosition = 0;
                        targetPosition = 4;
                      //  floorText = "Etaj 4";
                        break;
                    case 0: // GoingUp
                        if (currentPosition < targetPosition) {
                            currentPosition += 0.5; // Urcăm la poziția intermediară sau următorul etaj
                        }
                        floorText = `Între etajul ${Math.floor(currentPosition)} și ${Math.ceil(currentPosition)}`;
                        break;
                    case 1: // GoingDown
                        if (currentPosition > targetPosition) {
                            currentPosition -= 0.5; // Coborâm la poziția intermediară sau etajul anterior
                        }
                        break;
                    case 7: // Stopped
                        floorText = "Oprit";
                        break;
                    case 8: // Running
                        targetPosition = 0;
                        floorText = "În funcțiune";
                        break;
                    case 9: // Wait
                        floorText = `Așteaptă`;
                        break;
                    default:
                       floorText = "necunoscut";
                       // console.log(event.state);
                        break;
                }
            
            event_old = events_new;

            floorSpan.textContent = floorText;
        }




        function startAutoReload() {
            loadEvents(); // Încarcă imediat
            autoReloadInterval = setInterval(loadEvents, 1000); // Reîncarcă la fiecare secundă
        }

        // Pornește reîncărcarea automată la încărcarea paginii
        startAutoReload();







    </script>
</body>
</html>